<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>环境-变量声明的幕后 | Deep JavaScript</title>
    <meta name="description" content="A book in the depths of JavaScript">
    <link rel="preload stylesheet" href="/deep-javascript-cn/assets/style.2120ade5.css" as="style">
    <script type="module" src="/deep-javascript-cn/assets/app.5fcc713e.js"></script>
    <link rel="preload" href="/deep-javascript-cn/assets/inter-roman-latin.2ed14f66.woff2" as="font" type="font/woff2" crossorigin="">
  <link rel="modulepreload" href="/deep-javascript-cn/assets/chunks/framework.103df890.js">
  <link rel="modulepreload" href="/deep-javascript-cn/assets/chunks/theme.c1c147d1.js">
  <link rel="modulepreload" href="/deep-javascript-cn/assets/2_Environments-under-the-hood-of-variables.md.b50f0b63.lean.js">
  <link rel="icon" href="/deep-javascript-cn/favicon.ico">
  <script id="check-dark-light">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-2bf54a99><!--[--><!--]--><!--[--><span tabindex="-1" data-v-f5a352f2></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-f5a352f2> Skip to content </a><!--]--><!----><header class="VPNav" data-v-2bf54a99 data-v-283c37a7><div class="VPNavBar has-sidebar" data-v-283c37a7 data-v-2264840b><div class="container" data-v-2264840b><div class="title" data-v-2264840b><div class="VPNavBarTitle has-sidebar" data-v-2264840b data-v-d298091b><a class="title" href="/deep-javascript-cn/" data-v-d298091b><!--[--><!--]--><!--[--><img class="VPImage logo" src="/deep-javascript-cn/js.svg" alt data-v-6dd5884f><!--]--><!--[-->Deep JavaScript<!--]--><!--[--><!--]--></a></div></div><div class="content" data-v-2264840b><div class="curtain" data-v-2264840b></div><div class="content-body" data-v-2264840b><!--[--><!--]--><div class="VPNavBarSearch search" style="--vp-meta-key:&#39;Meta&#39;;" data-v-2264840b><!----></div><!----><!----><div class="VPNavBarAppearance appearance" data-v-2264840b data-v-0088fcc3><label title="toggle dark mode" data-v-0088fcc3 data-v-6efeb7e0><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-checked="false" data-v-6efeb7e0 data-v-5c77962f><span class="check" data-v-5c77962f><span class="icon" data-v-5c77962f><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-6efeb7e0><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-6efeb7e0><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></label></div><!----><div class="VPFlyout VPNavBarExtra extra" data-v-2264840b data-v-206ebc7c data-v-529736ff><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-529736ff><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-529736ff><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-529736ff><div class="VPMenu" data-v-529736ff data-v-280e28cb><!----><!--[--><!--[--><!----><div class="group" data-v-206ebc7c><div class="item appearance" data-v-206ebc7c><p class="label" data-v-206ebc7c>Appearance</p><div class="appearance-action" data-v-206ebc7c><label title="toggle dark mode" data-v-206ebc7c data-v-6efeb7e0><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-checked="false" data-v-6efeb7e0 data-v-5c77962f><span class="check" data-v-5c77962f><span class="icon" data-v-5c77962f><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-6efeb7e0><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-6efeb7e0><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></label></div></div></div><!----><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-2264840b data-v-47edab87><span class="container" data-v-47edab87><span class="top" data-v-47edab87></span><span class="middle" data-v-47edab87></span><span class="bottom" data-v-47edab87></span></span></button></div></div></div></div><!----></header><div class="VPLocalNav" data-v-2bf54a99 data-v-b59ad933><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-b59ad933><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-b59ad933><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-b59ad933>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-b59ad933 data-v-c20a59a7><button data-v-c20a59a7>Return to top</button><!----></div></div><aside class="VPSidebar" data-v-2bf54a99 data-v-c7a7361d><div class="curtain" data-v-c7a7361d></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-c7a7361d><span class="visually-hidden" id="sidebar-aria-label" data-v-c7a7361d> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-c7a7361d><section class="VPSidebarItem level-0 has-active" data-v-c7a7361d data-v-b1f1ab92><div class="item" role="button" tabindex="0" data-v-b1f1ab92><div class="indicator" data-v-b1f1ab92></div><h2 class="text" data-v-b1f1ab92>Ⅱ.类型，值，和变量</h2><!----></div><div class="items" data-v-b1f1ab92><!--[--><div class="VPSidebarItem level-1 is-link" data-v-b1f1ab92 data-v-b1f1ab92><div class="item" data-v-b1f1ab92><div class="indicator" data-v-b1f1ab92></div><a class="VPLink link link" href="/deep-javascript-cn/2/Type-coercion-in-JavaScript.html" data-v-b1f1ab92 data-v-d502cd7b><!--[--><p class="text" data-v-b1f1ab92>2.⚡JS中的类型强转</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b1f1ab92 data-v-b1f1ab92><div class="item" data-v-b1f1ab92><div class="indicator" data-v-b1f1ab92></div><a class="VPLink link link" href="/deep-javascript-cn/2/The-destructuring-algorithm.html" data-v-b1f1ab92 data-v-d502cd7b><!--[--><p class="text" data-v-b1f1ab92>3.解构算法</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link is-active has-active" data-v-b1f1ab92 data-v-b1f1ab92><div class="item" data-v-b1f1ab92><div class="indicator" data-v-b1f1ab92></div><a class="VPLink link link" href="/deep-javascript-cn/2/Environments-under-the-hood-of-variables.html" data-v-b1f1ab92 data-v-d502cd7b><!--[--><p class="text" data-v-b1f1ab92>4.⚡环境-变量背后的原理</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b1f1ab92 data-v-b1f1ab92><div class="item" data-v-b1f1ab92><div class="indicator" data-v-b1f1ab92></div><a class="VPLink link link" href="/deep-javascript-cn/2/A-detailed-look-at-global-variables.html" data-v-b1f1ab92 data-v-d502cd7b><!--[--><p class="text" data-v-b1f1ab92>5.⚡深入理解全局变量</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-c7a7361d><section class="VPSidebarItem level-0" data-v-c7a7361d data-v-b1f1ab92><div class="item" role="button" tabindex="0" data-v-b1f1ab92><div class="indicator" data-v-b1f1ab92></div><h2 class="text" data-v-b1f1ab92>Ⅲ.数据处理</h2><!----></div><div class="items" data-v-b1f1ab92><!--[--><div class="VPSidebarItem level-1 is-link" data-v-b1f1ab92 data-v-b1f1ab92><div class="item" data-v-b1f1ab92><div class="indicator" data-v-b1f1ab92></div><a class="VPLink link link" href="/deep-javascript-cn/3/Copying-objects-and-arrays.html" data-v-b1f1ab92 data-v-d502cd7b><!--[--><p class="text" data-v-b1f1ab92>7.JS对象和数组的拷贝</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b1f1ab92 data-v-b1f1ab92><div class="item" data-v-b1f1ab92><div class="indicator" data-v-b1f1ab92></div><a class="VPLink link link" href="/deep-javascript-cn/3/Updating-data-destructively-and-non-destructively.html" data-v-b1f1ab92 data-v-d502cd7b><!--[--><p class="text" data-v-b1f1ab92>8.破坏性和非破坏性更新数据</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b1f1ab92 data-v-b1f1ab92><div class="item" data-v-b1f1ab92><div class="indicator" data-v-b1f1ab92></div><a class="VPLink link link" href="/deep-javascript-cn/3/The-problem-of-shared-mutable-state-and-how-to-avoid-them.html" data-v-b1f1ab92 data-v-d502cd7b><!--[--><p class="text" data-v-b1f1ab92>9.共享可变状态问题</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-c7a7361d><section class="VPSidebarItem level-0" data-v-c7a7361d data-v-b1f1ab92><div class="item" role="button" tabindex="0" data-v-b1f1ab92><div class="indicator" data-v-b1f1ab92></div><h2 class="text" data-v-b1f1ab92>Ⅳ.OOP：对象属性特性</h2><!----></div><div class="items" data-v-b1f1ab92><!--[--><div class="VPSidebarItem level-1 is-link" data-v-b1f1ab92 data-v-b1f1ab92><div class="item" data-v-b1f1ab92><div class="indicator" data-v-b1f1ab92></div><a class="VPLink link link" href="/deep-javascript-cn/4/Property-attributes-an-Introduction.html" data-v-b1f1ab92 data-v-d502cd7b><!--[--><p class="text" data-v-b1f1ab92>10.⚡属性特性介绍</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b1f1ab92 data-v-b1f1ab92><div class="item" data-v-b1f1ab92><div class="indicator" data-v-b1f1ab92></div><a class="VPLink link link" href="/deep-javascript-cn/4/Protecting-objects-from-changed.html" data-v-b1f1ab92 data-v-d502cd7b><!--[--><p class="text" data-v-b1f1ab92>11.保护对象更改</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b1f1ab92 data-v-b1f1ab92><div class="item" data-v-b1f1ab92><div class="indicator" data-v-b1f1ab92></div><a class="VPLink link link" href="/deep-javascript-cn/4/Properties-assignment-vs-definition.html" data-v-b1f1ab92 data-v-d502cd7b><!--[--><p class="text" data-v-b1f1ab92>12.⚡属性赋值和属性定义</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b1f1ab92 data-v-b1f1ab92><div class="item" data-v-b1f1ab92><div class="indicator" data-v-b1f1ab92></div><a class="VPLink link link" href="/deep-javascript-cn/4/Enumerability-of-Properties.html" data-v-b1f1ab92 data-v-d502cd7b><!--[--><p class="text" data-v-b1f1ab92>13.属性的可枚举性</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-c7a7361d><section class="VPSidebarItem level-0" data-v-c7a7361d data-v-b1f1ab92><div class="item" role="button" tabindex="0" data-v-b1f1ab92><div class="indicator" data-v-b1f1ab92></div><h2 class="text" data-v-b1f1ab92>Ⅴ.OOP技术</h2><!----></div><div class="items" data-v-b1f1ab92><!--[--><div class="VPSidebarItem level-1 is-link" data-v-b1f1ab92 data-v-b1f1ab92><div class="item" data-v-b1f1ab92><div class="indicator" data-v-b1f1ab92></div><a class="VPLink link link" href="/deep-javascript-cn/5/Techniques-for-instantiating-classes.html" data-v-b1f1ab92 data-v-d502cd7b><!--[--><p class="text" data-v-b1f1ab92>14.⚡实例化类技术（异步属性）</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b1f1ab92 data-v-b1f1ab92><div class="item" data-v-b1f1ab92><div class="indicator" data-v-b1f1ab92></div><a class="VPLink link link" href="/deep-javascript-cn/5/Copying-instances-of-classes-clone-vs-copy-constructors.html" data-v-b1f1ab92 data-v-d502cd7b><!--[--><p class="text" data-v-b1f1ab92>15.类实例拷贝-clone&拷贝构造器</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b1f1ab92 data-v-b1f1ab92><div class="item" data-v-b1f1ab92><div class="indicator" data-v-b1f1ab92></div><a class="VPLink link link" href="/deep-javascript-cn/5/Immutable-wrappers-for-collections.html" data-v-b1f1ab92 data-v-d502cd7b><!--[--><p class="text" data-v-b1f1ab92>16.集合不可变性包装器</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-c7a7361d><section class="VPSidebarItem level-0" data-v-c7a7361d data-v-b1f1ab92><div class="item" role="button" tabindex="0" data-v-b1f1ab92><div class="indicator" data-v-b1f1ab92></div><h2 class="text" data-v-b1f1ab92>Ⅵ.正则表达式</h2><!----></div><div class="items" data-v-b1f1ab92><!--[--><div class="VPSidebarItem level-1 is-link" data-v-b1f1ab92 data-v-b1f1ab92><div class="item" data-v-b1f1ab92><div class="indicator" data-v-b1f1ab92></div><a class="VPLink link link" href="/deep-javascript-cn/6/Regular-expressions-lookaround-assertions-by-example.html" data-v-b1f1ab92 data-v-d502cd7b><!--[--><p class="text" data-v-b1f1ab92>17.⚡正则环视断言</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-c7a7361d><section class="VPSidebarItem level-0" data-v-c7a7361d data-v-b1f1ab92><div class="item" role="button" tabindex="0" data-v-b1f1ab92><div class="indicator" data-v-b1f1ab92></div><h2 class="text" data-v-b1f1ab92>Ⅶ.其它话题：元编程</h2><!----></div><div class="items" data-v-b1f1ab92><!--[--><div class="VPSidebarItem level-1 is-link" data-v-b1f1ab92 data-v-b1f1ab92><div class="item" data-v-b1f1ab92><div class="indicator" data-v-b1f1ab92></div><a class="VPLink link link" href="/deep-javascript-cn/7/Metaprogramming-with-Proxies.html" data-v-b1f1ab92 data-v-d502cd7b><!--[--><p class="text" data-v-b1f1ab92>20.⚡使用Proxies进行元编程</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-2bf54a99 data-v-e1441724><div class="VPDoc has-sidebar has-aside" data-v-e1441724 data-v-e031c361><!--[--><!--]--><div class="container" data-v-e031c361><div class="aside" data-v-e031c361><div class="aside-curtain" data-v-e031c361></div><div class="aside-container" data-v-e031c361><div class="aside-content" data-v-e031c361><div class="VPDocAside" data-v-e031c361 data-v-6db944aa><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" data-v-6db944aa data-v-12ef9dee><div class="content" data-v-12ef9dee><div class="outline-marker" data-v-12ef9dee></div><div class="outline-title" data-v-12ef9dee>目录</div><nav aria-labelledby="doc-outline-aria-label" data-v-12ef9dee><span class="visually-hidden" id="doc-outline-aria-label" data-v-12ef9dee> Table of Contents for current page </span><ul class="root" data-v-12ef9dee data-v-df1a6cf2><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-6db944aa></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-e031c361><div class="content-container" data-v-e031c361><!--[--><!--]--><!----><main class="main" data-v-e031c361><div style="position:relative;" class="vp-doc _deep-javascript-cn_2_Environments-under-the-hood-of-variables" data-v-e031c361><div><p>目录：</p><nav class="table-of-contents"><ul><li><a href="#_1️⃣-环境-一种管理变量的数据结构">1️⃣ 环境：一种管理变量的数据结构</a></li><li><a href="#_2️⃣-通过环境进行递归">2️⃣ 通过环境进行递归</a><ul><li><a href="#_2-1-执行代码">2.1 执行代码</a></li></ul></li><li><a href="#_3️⃣-通过环境形成嵌套作用域">3️⃣ 通过环境形成嵌套作用域</a><ul><li><a href="#_3-1-执行代码">3.1 执行代码</a></li></ul></li><li><a href="#_4️⃣-闭包与环境">4️⃣ 闭包与环境</a><ul><li><a href="#_4-1-执行代码">4.1 执行代码</a></li></ul></li></ul></nav><h2 id="_1️⃣-环境-一种管理变量的数据结构" tabindex="-1">1️⃣ 环境：一种管理变量的数据结构 <a class="header-anchor" href="#_1️⃣-环境-一种管理变量的数据结构" aria-label="Permalink to &quot;1️⃣ 环境：一种管理变量的数据结构&quot;">​</a></h2><p>🚀 <em>环境是ECMAScript规范中用于管理变量的一种数据结构</em></p><ul><li>它是一个字典，其keys是变量名，其值是对应变量的值</li><li>每个作用域（<code>scope</code>）都有相关联的环境</li><li>💡环境必须支持以下与变量相关的现象 <ul><li>递归（<code>Recursion</code>）</li><li>嵌套作用域（<code>Nested scopes</code>）</li><li>闭包（<code>Closures</code>）</li></ul></li></ul><p>接下来会用示例演示每一种现象是如何完成的。</p><p id="2"></p><h2 id="_2️⃣-通过环境进行递归" tabindex="-1">2️⃣ 通过环境进行递归 <a class="header-anchor" href="#_2️⃣-通过环境进行递归" aria-label="Permalink to &quot;2️⃣ 通过环境进行递归&quot;">​</a></h2><p>我们先处理递归，演示代码：</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">f</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">x</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">x</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">2</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">g</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">y</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">tmp</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">y</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">f</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">tmp</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">assert</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">equal</span><span style="color:#A6ACCD;">(</span><span style="color:#82AAFF;">g</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">8</span><span style="color:#A6ACCD;">)</span></span></code></pre></div><p>对每个函数的调用，你需要为调用的函数的变量（<em>参数和本地变量</em>）刷新存储空间。</p><p>👩🏻‍🏫</p><ol><li>这是通过一种叫做 <em>执行上下文（<code>execution contexts</code>）的<strong>栈</strong>管理的</em>，这个执行上下文指向环境（<code>environments</code>）😎</li><li>环境自身是存在于堆（<code>Heap</code>）中的。存在于堆中是有必要的，因为在执行离开它们的作用域后，它们偶尔会继续存在（闭包现象）。因此它们不能通过栈就行管理</li></ol><p id="2.1"></p><h3 id="_2-1-执行代码" tabindex="-1">2.1 执行代码 <a class="header-anchor" href="#_2-1-执行代码" aria-label="Permalink to &quot;2.1 执行代码&quot;">​</a></h3><p>当执行代码时，我们做下面暂停⏸（<code>pauses</code>）:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight has-highlighted-lines"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">f</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">x</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line highlighted"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// 暂停3</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">x</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">2</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">g</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">y</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">tmp</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">y</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span></span>
<span class="line highlighted"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// 暂停2</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">f</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">tmp</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="color:#676E95;font-style:italic;">// 暂停1</span></span>
<span class="line"><span style="color:#A6ACCD;">assert</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">equal</span><span style="color:#A6ACCD;">(</span><span style="color:#82AAFF;">g</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">8</span><span style="color:#A6ACCD;">)</span></span></code></pre></div><p>这个过程是：</p><ul><li>暂停1：在调用 <code>g()</code> 之前</li><li>暂停2：当执行 <code>g()</code> 时</li><li>暂停3：当执行 <code>f()</code> 时</li><li>剩下步骤：每次碰到 <code>return</code> 语句时，一个 <em>执行上下文（<code>execution context</code>）</em> 从栈（<code>stack</code>） 中移除</li></ul><p>步骤图解：</p><p><img src="/deep-javascript-cn/assets/04-recursion-1.2b2205ff.png" alt="04-recursion-1"></p><p>👆🏻暂停1 - 在调用 <code>g()</code> 之前：执行上下文栈有一个条目(<code>entry</code>)，指向最顶层的环境（译者注：最顶层环境为全局环境）。在这个环境中有2个条目：一个是<code>f()</code>另一个是 <code>g()</code>。</p><p><img src="/deep-javascript-cn/assets/04-recursion-2.e3ce9096.png" alt="04-recursion-2"></p><p>暂停2 - 执行 <code>g()</code> 时：最顶部的执行上下文栈（译者注：调用g()函数时，g()函数压入栈，位于栈的最顶部）指向为 <code>g()</code> 函数创建的环境（新的一个环境）。这个环境包括了参数 <code>y</code> 和本地变量 <code>tmp</code> 2个条目。</p><p><img src="/deep-javascript-cn/assets/04-recursion-3.f506810c.png" alt="04-recursion-3"></p><p>暂停3 - 当执行 <code>f()</code> 函数时：最上层的执行上下文（译者注：此时是 <code>f(x)</code> 在栈的最上层）指向 <code>f()</code> 创建的环境。</p><p id="3"></p><h2 id="_3️⃣-通过环境形成嵌套作用域" tabindex="-1">3️⃣ 通过环境形成嵌套作用域 <a class="header-anchor" href="#_3️⃣-通过环境形成嵌套作用域" aria-label="Permalink to &quot;3️⃣ 通过环境形成嵌套作用域&quot;">​</a></h2><p>使用下面代码探索如何通过环境形成嵌套作用域（<code>Nestes Scopes</code>）:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">f</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">x</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">function</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">square</span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">result</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">x</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">x</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">result</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">  </span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">sqaure</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">assert</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">equal</span><span style="color:#A6ACCD;">(</span><span style="color:#82AAFF;">f</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">6</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">36</span><span style="color:#A6ACCD;">)</span></span></code></pre></div><p>这里我们有3个嵌套作用域：最上层的作用域（译者注：全局作用域），<code>f()</code> 的作用域，<code>square()</code> 的作用域。观察：</p><ul><li>📚作用域是连在一起的。内部作用域继承所有外部作用域的变量，除了哪些被遮挡（<code>shadowed</code>）的变量（译者注：比如外部作用域定义了一个 <code>const a = 10</code>, 而内部作用域也定义了一个 <code>a</code> 变量，则内部作用域的变量 <code>a</code> 会遮挡外部作用域的变量 <code>a</code>）</li><li>嵌套作用域是独立于递归的机制。递归最好由独立的环境堆管理，而嵌套作用域则表示环境与其创建环境之间的关系</li></ul><p>🚀 因此，<em>每个作用域的环境通过一个名为 <code>outer</code> 的属性指向它周围作用域的环境</em>。</p><ul><li>当我们查询一个变量的值时，我们先在当前环境中搜索该名字的变量</li><li>如果找不到就在其外部环境（<code>outer environment</code>）中查找，如果还找不到，就接着在外部环境的外部环境中查找（译者注：类似原型链）</li><li>当前环境能访问整个外部环境链中包含的所有变量（除了遮挡的变量）</li></ul><p>🚀 <em>当你调用函数时，就会创建一个新的环境</em>。当前环境的外部环境是创建该函数的环境📚。为了帮助设置通过函数调用而生成的环境的 <code>outer</code> 属性，每个函数内部有一个叫 <code>[[Scope]]</code> 的属性会指向其出生环境（<code>birth environment</code>） 🤩。</p><p id="3.1"></p><h3 id="_3-1-执行代码" tabindex="-1">3.1 执行代码 <a class="header-anchor" href="#_3-1-执行代码" aria-label="Permalink to &quot;3.1 执行代码&quot;">​</a></h3><p>下面是我们执行代码是的暂停点：</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight has-highlighted-lines"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">f</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">x</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">function</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">square</span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">result</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">x</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">x</span></span>
<span class="line highlighted"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// 暂停3</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">result</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">  </span></span>
<span class="line highlighted"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// 暂停2</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">sqaure</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="color:#676E95;font-style:italic;">// 暂停1</span></span>
<span class="line"><span style="color:#A6ACCD;">assert</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">equal</span><span style="color:#A6ACCD;">(</span><span style="color:#82AAFF;">f</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">6</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">36</span><span style="color:#A6ACCD;">)</span></span></code></pre></div><p>这个过程是：</p><ul><li>暂停1 - 在调用 <code>f()</code> 函数前</li><li>暂停2 - 当执行 <code>f()</code> 函数时</li><li>暂停3 - 当执行 <code>square()</code> 函数时</li><li>之后，<code>return</code> 语句函数出栈</li></ul><p>步骤图解：</p><p><img src="/deep-javascript-cn/assets/04-scope-1.f6202637.png" alt="04-scope-1"></p><p>👆🏻暂停1 - 在调用 <code>f()</code> 函数前：最上层环境（全局环境）有一个条目，即 <code>f()</code>。 而 <code>f()</code> 函数的出生环境为最上层环境（译者注：即这里的全局环境）。因此 f 函数的 <code>[[Scope]]</code> 指向这个全局环境。</p><p><img src="/deep-javascript-cn/assets/04-scope-2.25f5e6b3.png" alt="04-scope-2"></p><p>暂停2 - 当执行 <code>f()</code> 函数时：现在已经存在一个调用 <code>f(6)</code> 的环境了（译者注：全局环境）。全局环境是<code>f()</code> 函数执行时所生成的环境的出生环境，因此执行 <code>f()</code> 函数的环境的 <code>outer</code> 属性指向全局环境。而新函数 <code>square()</code> 的 <code>[[Scope]]</code> 指向创建它的环境（即这里的 f(x)执行生成的环境）。</p><p><img src="/deep-javascript-cn/assets/04-scope-3.7a973295.png" alt="04-scope-3"></p><p>暂停3 - 当执行 <code>square()</code> 函数时：重复先前模式：square函数执行生成的环境的 <code>outer</code> 指向其 <code>[[Scope]]</code> 指向的环境。<em>作用域链通过 <code>outer</code> 属性创建，包含所有活动的变量📚</em>。例如，如果我们愿意的话，可以访问 <code>result</code> &amp; <code>square</code> &amp; <code>f</code> 变量。环境反应了变量的2个方面：</p><ol><li>外部环境链反应了嵌套静态作用域</li><li>执行上下文栈反应了正在动态调用哪一个函数</li></ol><p id="4"></p><h2 id="_4️⃣-闭包与环境" tabindex="-1">4️⃣ 闭包与环境 <a class="header-anchor" href="#_4️⃣-闭包与环境" aria-label="Permalink to &quot;4️⃣ 闭包与环境&quot;">​</a></h2><p>为了了解环境如何用于实现 <a href="https://exploringjs.com/impatient-js/ch_variables-assignment.html#closures" target="_blank" rel="noreferrer">闭包（<code>closures</code>）</a>，我们使用下面示例：</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">add</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">x</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">y</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// A</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">x</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">y</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">assert</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">equal</span><span style="color:#A6ACCD;">(</span><span style="color:#82AAFF;">add</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;">)(</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">4</span><span style="color:#A6ACCD;">) </span><span style="color:#676E95;font-style:italic;">// B</span></span></code></pre></div><p>这里发生了什么？<code>add()</code> 是一个函数，它返回另一个函数。当我们在B行位置调用嵌套函数 <code>add(3)(1)</code> 时，第一个参数是给 <code>add()</code> 的，第2个参数则是给它返回的函数的。 <em>这是可行的，因为在A行位置创建的函数在离开出生作用域（<code>birth scope</code>）时不会失去与该作用域的连接。</em> 关联的环境通过这种联系得以存活下来，函数仍可访问变量 那个环境中的 <code>x</code>（x在该函数中被释放）。</p><p>这种嵌套调用 <code>add()</code> 的方式有个优点：你可以先调用第一个函数，得到一个参数已经填充的 <code>add()</code> 版本：</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> plus2 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">add</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#82AAFF;">assert</span><span style="color:#A6ACCD;">(</span><span style="color:#82AAFF;">plus2</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">5</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">7</span><span style="color:#A6ACCD;">)</span></span></code></pre></div><p>📚将一个有2个参数的函数转换为参数各1个的2个嵌套的函数，这称之为库里（<code>currying</code>）, <code>add()</code> 就是一个库里化的函数。</p><p>只填充函数的部分参数称之为 <em>部分应用（<code>partial application</code>）</em> （函数还没有完全应用）。<a href="https://exploringjs.com/impatient-js/ch_single-objects.html#function-prototype-bind" target="_blank" rel="noreferrer">bind()</a> 函数便执行了部分应用。在上面的例子中，我们可以发现，对一个函数进行库里化，部分应用变得很简单。</p><p id="4.1"></p><h3 id="_4-1-执行代码" tabindex="-1">4.1 执行代码 <a class="header-anchor" href="#_4-1-执行代码" aria-label="Permalink to &quot;4.1 执行代码&quot;">​</a></h3><p>当我们执行上面代码时，添加3个暂停点：</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight has-highlighted-lines"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">add</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">x</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;font-style:italic;">y</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line highlighted"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// 暂停3：plus2(5)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">x</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">y</span></span>
<span class="line highlighted"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// 暂停1：add(2)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> plus2 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">add</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="color:#676E95;font-style:italic;">// 暂停2</span></span>
<span class="line"><span style="color:#A6ACCD;">assert</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">equal</span><span style="color:#A6ACCD;">(</span><span style="color:#82AAFF;">plus2</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">5</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">7</span><span style="color:#A6ACCD;">)</span></span></code></pre></div><p>这个过程是：</p><ul><li>暂停1 - 在执行 <code>add(2)</code> 过程</li><li>暂停2 - 在执行 <code>add(2)</code> 之后</li><li>暂停3 - 当执行 <code>plus2(5)</code> 时</li></ul><p>步骤图解：</p><p><img src="/deep-javascript-cn/assets/04-closure-1.b67e274c.png" alt="04-closure-1"></p><p>👆🏻暂停1 - 在执行 <code>add(2)</code> 过程：这里可以看到 <code>add()</code> 返回的函数已经存在（右下角），因此返回的函数的内部属性 <code>[[Scope]]</code> 指向它的出生环境（<code>birth environment</code>）。</p><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p><code>plus2</code> 处于临时死区（<code>TDZ</code>） ，未被初始化。</p></div><p><img src="/deep-javascript-cn/assets/04-closure-2.15b4b13a.png" alt="04-closure-2"></p><p>🚀暂停2 - 在执行 <code>add(2)</code> 之后：<code>plus2</code> 现在指向 <code>add(2)</code> 返回的函数。该函数通过 <code>[[Scope]]</code> 属性保持它的出生环境（即 <code>add(2)</code> 执行环境）在 <code>add(2)</code> 执行完成出栈之后仍旧存活。</p><p><img src="/deep-javascript-cn/assets/04-closure-3.5ad9827a.png" alt="04-closure-3"></p><p>暂停3 - 当执行 <code>plus2(5)</code> 时：执行 <code>plus2(5)</code> 产生的新环境的 <code>outer</code>属性指向 <code>plus2</code> 指向的 <code> [[Scope]]</code> 指向的环境，这也是为什么当前函数能访问 <code>x</code> 的原因 😎。</p><p>原文链接：</p><ul><li><a href="https://exploringjs.com/deep-js/ch_environments.html" target="_blank" rel="noreferrer">4 Environments: under the hood of variables</a></li></ul><p>2022年07月05日01:04:21</p><p>PS: 相比于原版配图，自己画的图添加了一些色彩和注解，但整体流程是一致的。</p></div></div></main><footer class="VPDocFooter" data-v-e031c361 data-v-6b942b4b><!--[--><!--]--><div class="edit-info" data-v-6b942b4b><div class="edit-link" data-v-6b942b4b><a class="VPLink link edit-link-button" href="https://github.com/jamessawyer/deep-javascript-cn/edit/main/docs/2/Environments-under-the-hood-of-variables.md" target="_blank" rel="noreferrer" data-v-6b942b4b data-v-d502cd7b><!--[--><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="edit-link-icon" aria-label="edit icon" data-v-6b942b4b><path d="M18,23H4c-1.7,0-3-1.3-3-3V6c0-1.7,1.3-3,3-3h7c0.6,0,1,0.4,1,1s-0.4,1-1,1H4C3.4,5,3,5.4,3,6v14c0,0.6,0.4,1,1,1h14c0.6,0,1-0.4,1-1v-7c0-0.6,0.4-1,1-1s1,0.4,1,1v7C21,21.7,19.7,23,18,23z"></path><path d="M8,17c-0.3,0-0.5-0.1-0.7-0.3C7,16.5,6.9,16.1,7,15.8l1-4c0-0.2,0.1-0.3,0.3-0.5l9.5-9.5c1.2-1.2,3.2-1.2,4.4,0c1.2,1.2,1.2,3.2,0,4.4l-9.5,9.5c-0.1,0.1-0.3,0.2-0.5,0.3l-4,1C8.2,17,8.1,17,8,17zM9.9,12.5l-0.5,2.1l2.1-0.5l9.3-9.3c0.4-0.4,0.4-1.1,0-1.6c-0.4-0.4-1.2-0.4-1.6,0l0,0L9.9,12.5z M18.5,2.5L18.5,2.5L18.5,2.5z"></path></svg> 在GitHub编辑此页<!--]--><!----></a></div><div class="last-updated" data-v-6b942b4b><p class="VPLastUpdated" data-v-6b942b4b data-v-d04e231d>Last updated: <time datetime="2023-04-26T02:07:53.000Z" data-v-d04e231d></time></p></div></div><div class="prev-next" data-v-6b942b4b><div class="pager" data-v-6b942b4b><a class="pager-link prev" href="/deep-javascript-cn/2/The-destructuring-algorithm.html" data-v-6b942b4b><span class="desc" data-v-6b942b4b>Previous page</span><span class="title" data-v-6b942b4b>3.解构算法</span></a></div><div class="has-prev pager" data-v-6b942b4b><a class="pager-link next" href="/deep-javascript-cn/2/A-detailed-look-at-global-variables.html" data-v-6b942b4b><span class="desc" data-v-6b942b4b>Next page</span><span class="title" data-v-6b942b4b>5.⚡深入理解全局变量</span></a></div></div></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"2_a-detailed-look-at-global-variables.md\":\"7534096b\",\"2_environments-under-the-hood-of-variables.md\":\"b50f0b63\",\"4_property-attributes-an-introduction.md\":\"4463ffdb\",\"3_copying-objects-and-arrays.md\":\"a2bac52c\",\"4_protecting-objects-from-changed.md\":\"3cfa465c\",\"2_the-destructuring-algorithm.md\":\"4a269bf2\",\"3_updating-data-destructively-and-non-destructively.md\":\"d5e261ea\",\"5_immutable-wrappers-for-collections.md\":\"f647bb17\",\"5_copying-instances-of-classes-clone-vs-copy-constructors.md\":\"9feeb4e9\",\"3_the-problem-of-shared-mutable-state-and-how-to-avoid-them.md\":\"8dff20fd\",\"4_enumerability-of-properties.md\":\"b7a29915\",\"5_techniques-for-instantiating-classes.md\":\"c73cb7c0\",\"6_regular-expressions-lookaround-assertions-by-example.md\":\"6efb02a3\",\"index.md\":\"7086f526\",\"4_properties-assignment-vs-definition.md\":\"3466f96c\",\"2_type-coercion-in-javascript.md\":\"909bfca7\",\"7_metaprogramming-with-proxies.md\":\"f3db2588\"}")
__VP_SITE_DATA__ = JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"Deep JavaScript\",\"description\":\"A book in the depths of JavaScript\",\"base\":\"/deep-javascript-cn/\",\"head\":[],\"appearance\":true,\"themeConfig\":{\"logo\":\"/js.svg\",\"outlineTitle\":\"目录\",\"outline\":[2,3],\"editLink\":{\"text\":\"在GitHub编辑此页\",\"pattern\":\"https://github.com/jamessawyer/deep-javascript-cn/edit/main/docs/:path\"},\"sidebar\":[{\"text\":\"Ⅱ.类型，值，和变量\",\"collapsible\":true,\"items\":[{\"text\":\"2.⚡JS中的类型强转\",\"link\":\"/2/Type-coercion-in-JavaScript\"},{\"text\":\"3.解构算法\",\"link\":\"/2/The-destructuring-algorithm\"},{\"text\":\"4.⚡环境-变量背后的原理\",\"link\":\"/2/Environments-under-the-hood-of-variables\"},{\"text\":\"5.⚡深入理解全局变量\",\"link\":\"/2/A-detailed-look-at-global-variables\"}]},{\"text\":\"Ⅲ.数据处理\",\"collapsible\":true,\"items\":[{\"text\":\"7.JS对象和数组的拷贝\",\"link\":\"/3/Copying-objects-and-arrays\"},{\"text\":\"8.破坏性和非破坏性更新数据\",\"link\":\"/3/Updating-data-destructively-and-non-destructively\"},{\"text\":\"9.共享可变状态问题\",\"link\":\"/3/The-problem-of-shared-mutable-state-and-how-to-avoid-them\"}]},{\"text\":\"Ⅳ.OOP：对象属性特性\",\"collapsible\":true,\"items\":[{\"text\":\"10.⚡属性特性介绍\",\"link\":\"/4/Property-attributes-an-Introduction\"},{\"text\":\"11.保护对象更改\",\"link\":\"/4/Protecting-objects-from-changed\"},{\"text\":\"12.⚡属性赋值和属性定义\",\"link\":\"/4/Properties-assignment-vs-definition\"},{\"text\":\"13.属性的可枚举性\",\"link\":\"/4/Enumerability-of-Properties\"}]},{\"text\":\"Ⅴ.OOP技术\",\"collapsible\":true,\"items\":[{\"text\":\"14.⚡实例化类技术（异步属性）\",\"link\":\"/5/Techniques-for-instantiating-classes\"},{\"text\":\"15.类实例拷贝-clone&拷贝构造器\",\"link\":\"/5/Copying-instances-of-classes-clone-vs-copy-constructors\"},{\"text\":\"16.集合不可变性包装器\",\"link\":\"/5/Immutable-wrappers-for-collections\"}]},{\"text\":\"Ⅵ.正则表达式\",\"collapsible\":true,\"items\":[{\"text\":\"17.⚡正则环视断言\",\"link\":\"/6/Regular-expressions-lookaround-assertions-by-example\"}]},{\"text\":\"Ⅶ.其它话题：元编程\",\"collapsible\":true,\"items\":[{\"text\":\"20.⚡使用Proxies进行元编程\",\"link\":\"/7/Metaprogramming-with-Proxies\"}]}]},\"locales\":{},\"scrollOffset\":90,\"cleanUrls\":false}")</script>
    
  </body>
</html>