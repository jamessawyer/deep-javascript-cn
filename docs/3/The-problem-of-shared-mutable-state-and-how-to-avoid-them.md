---
title: å…±äº«å¯å˜çŠ¶æ€é—®é¢˜
---
ç›®å½•ï¼š
[[toc]]



æœ¬ç« å°†å›ç­”å¦‚ä¸‹3ä¸ªé—®é¢˜ï¼š

1. ä»€ä¹ˆæ˜¯å…±äº«å¯å˜çŠ¶æ€ï¼Ÿ
2. ä¸ºä»€ä¹ˆå…±äº«å¯å˜çŠ¶æ€ä¼šæˆä¸ºéº»çƒ¦ï¼Ÿ
3. å¦‚ä½•é¿å…è¿™äº›éº»çƒ¦ï¼Ÿ



<p id="1"></p>



## 1ï¸âƒ£ ä»€ä¹ˆæ˜¯å…±äº«å¯å˜çŠ¶æ€åŠä¸ºä»€ä¹ˆè¿™ä¼šæˆä¸ºé—®é¢˜?

å…±äº«å¯å˜çŠ¶æ€æ•ˆæœå¦‚ä¸‹ï¼š

- å¦‚æœ2æ–¹æˆ–æ›´å¤šæ–¹ï¼ˆ`parties`ï¼‰å¯ä»¥æ”¹å˜ç›¸åŒçš„æ•°æ®ï¼ˆå˜é‡ï¼Œå¯¹è±¡ç­‰ï¼‰
- å¹¶ä¸”å®ƒä»¬çš„ç”Ÿå‘½å‘¨æœŸæœ‰é‡å 
- åˆ™ä¼šå­˜åœ¨æŸä¸€æ–¹çš„ä¿®æ”¹ä¼šå¯¼è‡´å…¶å®ƒæ–¹ä¸èƒ½æ­£å¸¸å·¥ä½œ

ğŸš¨æ³¨æ„è¿™ä¸ªå®šä¹‰é€‚ç”¨äºå‡½æ•°è°ƒç”¨ï¼Œåä½œå¼å¤šä»»åŠ¡ï¼ˆæ¯”å¦‚ï¼ŒJSä¸­çš„å¼‚æ­¥å‡½æ•°ï¼‰ç­‰ã€‚é£é™©éƒ½ç±»ä¼¼ã€‚

ä¸‹é¢ä»£ç æ˜¯ä¸ªä¾‹å­ã€‚è¿™ä¸ªä¾‹å­ä¸å¤ªç°å®ï¼Œä»…åšæ¼”ç¤ºå’Œä¾¿äºç†è§£ä½¿ç”¨ï¼š

```js {2-4,13,16}
function logElements(arr) {
  while (arr.length > 0) {
    console.log(arr.shift())
  }
}

function main() {
  const arr = ['banana', 'orange', 'apple']
  
  console.log('Before sorting')
  logElements(arr)
  
  arr.sort() // æ”¹å˜äº†arr
  
  console.log('After sorting:')
  logElements(arr)  // A
}
main()

// è¾“å‡ºç»“æœ
// 'Before sorting:'
// 'banana'
// 'orange'
// 'apple'
// 'After sorting:'
```

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæœ‰ä¸¤ä¸ªç‹¬ç«‹çš„å½“äº‹æ–¹:

- å‡½æ•° `main()` æƒ³è¦åœ¨æ•°ç»„æ’åºå‰åè®°å½•å®ƒ
- å‡½æ•° `logElements()` è®°å½•å…¶å‚æ•° `arr` ä¸­çš„å…ƒç´ ï¼Œä½†æ˜¯è¿™æ ·åšçš„æ—¶å€™å´ç§»é™¤äº†æ•°ç»„ä¸­çš„å…ƒç´ ğŸ˜…

`logElements()` ç ´åäº† `main()`ï¼Œå¹¶å¯¼è‡´ `A` è¡Œæ‰“å°äº†ä¸€ä¸ªç©ºæ•°ç»„ã€‚

åœ¨æœ¬ç« åç»­éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†çœ‹3ç§é¿å…å…±äº«å¯å˜çŠ¶æ€å¼•å‘çš„é—®é¢˜çš„3ç§æ–¹å¼ï¼š

1. é€šè¿‡æ‹·è´æ•°æ®é¿å…å…±äº«
2. é€šè¿‡éç ´åæ€§æ›´æ–°é¿å…çªå˜ï¼ˆ`mutations`ï¼‰
3. ä½¿æ•°æ®ä¸å¯å˜ï¼ˆ`immutable`ï¼‰ä»¥ä¾¿é˜»æ­¢çªå˜

ç‰¹åˆ«çš„ï¼Œæˆ‘ä»¬å°†ç¨åå›é¡¾ä¸Šé¢çš„ä¾‹å­ï¼Œå¹¶ä¿®å¤å®ƒã€‚



<p id="2"></p>



## 2ï¸âƒ£ é€šè¿‡æ‹·è´æ•°æ®é¿å…å…±äº«

*æ‹·è´æ•°æ®æ˜¯é¿å…å…±äº«çš„ä¸€ç§æ–¹å¼ã€‚*

ğŸ’¡å¯¹æ‹·è´æ•°æ®ï¼Œå¯ä»¥å‚è€ƒæœ¬ä¹¦çš„ä¸‹é¢2ç« ï¼š

- [7.Copying objects and Arrays](./Copying-objects-and-Arrays)
- [15.Copying instances of classes: .clone() vs. copy constructors](../5/Copying-instances-of-classes-clone-vs-copy-constructors)



<p id="2.1"></p>



### 2.1 æ‹·è´æ˜¯å¦‚ä½•å¸®åŠ©è§£å†³å…±äº«å¯å˜çŠ¶æ€çš„ï¼Ÿ

**åªè¦æˆ‘ä»¬åªä»å…±äº«æ•°æ®ä¸­ è¯»ï¼ˆ`read`ï¼‰æ•°æ®ï¼Œæˆ‘ä»¬ä»€ä¹ˆé—®é¢˜ä¹Ÿæ²¡æœ‰**ã€‚åœ¨ *ä¿®æ”¹ï¼ˆ`modifying`ï¼‰* æ•°æ®å‰ï¼Œæˆ‘ä»¬å¯é€šè¿‡æ‹·è´ï¼ˆå¿…è¦æ—¶éœ€æ·±æ‹·è´ï¼‰æ–¹å¼ *å–æ¶ˆå…±äº«ï¼ˆ`un-share`ï¼‰* å®ƒã€‚

ğŸš€ğŸš€ *é˜²å¾¡æ€§æ‹·è´ï¼ˆ`Defensive copying`ï¼‰* æ˜¯ä¸€ç§åœ¨å¯èƒ½å‡ºç°é—®é¢˜æ—¶å§‹ç»ˆè¿›è¡Œå¤åˆ¶çš„æŠ€æœ¯ã€‚å®ƒçš„ç›®çš„æ˜¯ä¿è¯å½“å‰å®ä½“ï¼ˆå‡½æ•°ï¼Œç±»ï¼Œç­‰ï¼‰çš„å®‰å…¨ï¼š

- è¾“å…¥ï¼šæ‹·è´æ½œåœ¨ä¼ ç»™æˆ‘ä»¬çš„å…±äº«æ•°æ®ï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥åœ¨ä¸æ‰“æ‰°å¤–éƒ¨æ•°æ®çš„å‰æä¸‹ï¼Œä½¿ç”¨è¯¥æ•°æ®
- è¾“å‡ºï¼šåœ¨æš´éœ²ç»™å¤–ç•Œå‰ï¼Œ æˆ‘ä»¬æ‹·è´å†…éƒ¨æ•°æ®ï¼Œè¿™æ„å‘³ç€å¤–éƒ¨ä¸èƒ½å¹²æ‰°åˆ°æˆ‘ä»¬å†…éƒ¨çš„æ´»åŠ¨

æ³¨æ„ï¼Œè¿™äº›æªæ–½ä¿æŠ¤æˆ‘ä»¬ä¸å—å…¶ä»–æ–¹é¢çš„å½±å“ï¼Œä½†å®ƒä»¬ä¹Ÿä¿æŠ¤å…¶ä»–æ–¹é¢ä¸å—æˆ‘ä»¬çš„å½±å“ã€‚

ä¸‹é¢é˜è¿°è¿™2ç§é˜²å¾¡æ€§æ‹·è´ã€‚



#### 2.1.1 æ‹·è´å…±äº«è¾“å…¥

è¿˜è®°å¾—åœ¨æœ¬ç« å¼€å§‹çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é‡åˆ°äº†éº»çƒ¦ï¼Œå› ä¸º`logElements()`ä¿®æ”¹äº†å®ƒçš„å‚æ•°`arr`:

```js
function logElements(arr) {
  while (arr.length > 0) {
    console.log(arr.shift())
  }
}
```

ğŸ˜è®©æˆ‘ä»¬ç»™è¿™ä¸ªå‡½æ•°æ·»åŠ é˜²å¾¡æ€§æ‹·è´ï¼š

```js {2}
function logElements(arr) {
  arr = [...arr] // é˜²å¾¡æ€§æ‹·è´
  while (arr.length) {
    console.log(arr.shift())
  }
}
```

ç°åœ¨ï¼Œæˆ‘ä»¬åœ¨ `main()` ä¸­å†è°ƒç”¨ `logElements()` ä¸ä¼šå­˜åœ¨ä»»ä½•é—®é¢˜äº†ï¼š

```js {20-22}
function main() {
  const arr = ['banana', 'orange', 'apple']
  
  console.log('Before sorting')
  logElements(arr)
  
  arr.sort() // æ”¹å˜äº†arr
  
  console.log('After sorting:')
  logElements(arr)  // A
}
main()

// æ‰“å°ç»“æœ
// 'Before sorting:'
// 'banana'
// 'orange'
// 'apple'
// 'After sorting:'
// 'apple'
// 'banana'
// 'orange'
```



#### 2.1.2 å¯¹æš´éœ²çš„å†…éƒ¨æ•°æ®è¿›è¡Œæ‹·è´

æˆ‘ä»¬å…ˆä»ç±» `StringBuilder` å¼€å§‹ï¼Œå®ƒåœ¨ `A` è¡Œæ²¡æœ‰æ‹·è´æš´éœ²ç»™å¤–éƒ¨çš„å†…éƒ¨æ•°æ®ï¼š

```js {6-10}
class StringBuilder {
  _data = []
  add(str) {
    this._data.push(str)
  }
  getParts() {
    // ğŸš¨ è¿™é‡Œå‘å¤–éƒ¨æš´éœ²äº†å†…éƒ¨æ•°æ®
    //    ä½†æ˜¯æ²¡æœ‰å¯¹å…¶è¿›è¡Œæ‹·è´
    return this._data  // A
  }
  
  toString() {
    return this._data.join('')
  }
}
```

åªè¦ä¸ä½¿ç”¨ `getParts()` æ–¹æ³•ï¼Œä¸€åˆ‡æ­£å¸¸:

```js
const sb1 = new StringBuilderr()
sb1.add('Hello')
sb1.add(' world!')
assert.equal(sb1.toString(), 'Hello world!')
```

ç„¶è€Œï¼Œå¦‚æœæ”¹å˜äº† `.getParts()` çš„è¿”å›ç»“æœï¼ˆ`A` è¡Œï¼‰ï¼Œä¼šä½¿å¾— `StringBuilder` å°†å˜å¾—ä¸æ­£å¸¸ï¼š

```js {4-5}
const sb2 = new StringBuilderr()
sb2.add('Hello')
sb2.add(' world!')
sb2.getParts().length = 0 // A
assert.equal(sb2.toString(), '') // âŒ ä¸æ­£å¸¸
```

ğŸ˜è§£å†³åŠæ³•å°±æ˜¯ï¼Œåœ¨æš´éœ²å†…éƒ¨æ•°æ® `_data` ä¹‹å‰ï¼ˆAè¡Œï¼‰å¯¹å…¶è¿›è¡Œé˜²å¾¡æ€§æ‹·è´ï¼š

```js {7-8}
class StringBuilder {
  _data = []
  add(str) {
    this._data.push(str)
  }
  getParts() {
    // ğŸš¨ é˜²å¾¡æ€§æ‹·è´
    return [...this._data ] // A
  }
  
  toString() {
    return this._data.join('')
  }
}
```

ç°åœ¨å†æ”¹å˜ `.getParts()` çš„ç»“æœä¸å†ä¼šå½±å“åˆ°å®ä¾‹çš„æ“ä½œï¼š

```js {4-5}
const sb = new StringBuilderr()
sb.add('Hello')
sb.add(' world!')
sb.getParts().length = 0 // A ä¸å†å½±å“å®ä¾‹sb
assert.equal(sb.toString(), 'Hello world!') // âœ…
```

<p id="3"></p>



## 3ï¸âƒ£ é€šè¿‡éç ´åæ€§æ›´æ–°é¿å…çªå˜

å¦‚æœæˆ‘ä»¬éç ´åæ€§çš„æ›´æ–°æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥é¿å…çªå˜ã€‚

ğŸ’¡å…³äºæ›´æ–°æ•°æ®ï¼Œå¯å‚è€ƒä¸Šä¸€ç« ï¼š

- [8.Updating data destructively and non-destructively](./Updating-data-destructively-and-non-destructively)



<p id="3.1"></p>



### 3.1 éç ´åæ€§æ›´æ–°å¦‚ä½•å¯¹å…±äº«å¯å˜çŠ¶æ€æœ‰å¸®åŠ©çš„ï¼Ÿ

é€šè¿‡éç ´åæ€§æ›´æ–°ï¼Œå…±äº«å¯å˜çŠ¶æ€ä¸å†æ˜¯é—®é¢˜ï¼Œå› ä¸ºæˆ‘ä»¬æ°¸è¿œä¸ä¼šæ”¹å˜è¯¥å…±äº«å¯å˜çŠ¶æ€ã€‚ï¼ˆæ³¨æ„ï¼šåªæœ‰æ¯ä¸ªè®¿é—®æ•°æ®çš„æ“ä½œéƒ½è¿™æ ·åšï¼Œæ‰æœ‰æ•ˆï¼‰ã€‚

æœ‰è¶£çš„æ˜¯ï¼Œæ‹·è´æ•°æ®å˜å¾—ååˆ†ç®€å•ï¼š

```js
const original = {city: 'Berlin', country: 'Germany'}
const copy = original
```

è¿™æ˜¯å¯è¡Œçš„ï¼Œå› ä¸ºæˆ‘ä»¬åªè¿›è¡Œéç ´åæ€§çš„æ›´æ”¹ï¼Œå› æ­¤æ ¹æ®éœ€è¦å¤åˆ¶æ•°æ®ã€‚



<p id="4"></p>



## 4ï¸âƒ£ ä½¿æ•°æ®ä¸å¯å˜çš„æ–¹å¼é˜»æ­¢çªå˜

**ğŸ“šæˆ‘ä»¬å¯ä»¥å°†å…±äº«æ•°æ®å˜ä¸ºä¸å¯å˜ï¼Œä»¥é˜»æ­¢å…¶çªå˜ã€‚**

JSä¸­å¦‚ä½•ä½¿æ•°æ®ä¸å¯å˜ï¼Œå¯å‚è€ƒä¸‹é¢2ç« ï¼š

- [11.Protecting objects from being changed](../4/Protecting-objects-from-changed)
- [16.Immutable wrappers for collections](../5/Immutable-wrappers-for-collections)



<p id="4.1"></p>



### 4.1 ä¸å¯å˜æ€§å¦‚ä½•å¸®åŠ©å…±äº«å¯å˜çŠ¶æ€çš„ï¼Ÿ

å¦‚æœæ•°æ®ä¸å¯å˜ï¼Œå®ƒå¯ä»¥æ— ä»»ä½•é£é™©å…±äº«ğŸ˜ã€‚ç‰¹åˆ«æ˜¯ï¼Œæ²¡æœ‰å¿…è¦å†è¿›è¡Œé˜²å¾¡æ€§çš„æ‹·è´äº†ã€‚

ğŸ’¡ *éç ´åæ€§æ›´æ–°æ—¶å¯¹ä¸å¯å˜æ•°æ®çš„ä¸€ä¸ªé‡è¦è¡¥å……*ï¼š

å¦‚æœæˆ‘ä»¬å°†2è€…ç»“åˆèµ·æ¥ï¼Œä¸å¯å˜æ•°æ®å°†å’Œå¯å˜æ•°æ®ä¸€æ ·å˜å¾—ååˆ†æœ‰ç”¨ï¼Œå¹¶ä¸”è¿˜æ²¡æœ‰ç›¸å…³çš„é£é™©ã€‚ğŸ¤©



<p id="5"></p>



## 5ï¸âƒ£ é¿å…å…±äº«å¯å˜çŠ¶æ€çš„åº“

JSä¸­æœ‰å‡ ä¸ªæ”¯æŒä¸å¯å˜æ•°æ®+éç ´åæ€§æ›´æ–°çš„åº“ã€‚æœ€æµè¡Œçš„2ä¸ªæ˜¯ï¼š

1. [Immutable.js](https://github.com/immutable-js/immutable-js) å¯¹lists, stacks, sets, mapsç­‰æä¾›ä¸å¯å˜æ•°æ®ç»“æ„
2. [Immer.js](https://immerjs.github.io/immer/) ä¹Ÿæ”¯æŒä¸å¯å˜æ•°æ®+éç ´åæ€§æ›´æ–°ï¼Œ*ä½†åªé’ˆå¯¹æ™®é€šçš„å¯¹è±¡ï¼Œæ•°ç»„ï¼ŒSetsï¼ŒMaps*ã€‚å³ä¸éœ€è¦æ–°çš„æ•°æ®ç»“æ„

ä¸‹é¢æ›´è¯¦ç»†çš„ä»‹ç»ä¸€ä¸‹è¿™2ä¸ªåº“ã€‚



<p id="5.1"></p>



### 5.1 Immutable.js

[Immutable.js](https://github.com/immutable-js/immutable-js) ä»“åº“æè¿°å¦‚ä¸‹ï¼š

- JavaScriptçš„ä¸å¯å˜æŒä¹…æ•°æ®é›†åˆæé«˜äº†æ•ˆç‡å’Œç®€å•æ€§ã€‚

Immutable.jsæä¾›äº†å¦‚ä¸‹ä¸å¯å˜æ•°æ®ç»“æ„ï¼š

- Lists
- Stack
- Set (ä¸åŒäºJSå†…ç½®çš„Set)
- Map (ä¸åŒäºJSå†…ç½®çš„Map)
- ç­‰ç­‰

ä¸‹é¢æˆ‘ä»¬ä½¿ç”¨ä¸å¯å˜çš„ `Map`:

```js {7,10,14,17-18}
import { Map } from 'immutable/dist/immutable.es.js'
const map0 = Map([
  [false, 'no'],
  [true, 'yes'],
])

// æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªä¿®æ”¹ç‰ˆæœ¬çš„map0
const map1 = map0.set(true, 'maybe')

// ğŸ’¡ ä¿®æ”¹ç‰ˆæœ¬ä¸åŒäºåŸç‰ˆæœ¬
assert.ok(map1 !== map0)
assert.equal(map1.equals(map0), false) // A

// æˆ‘ä»¬æ’¤é”€ä¹‹å‰çš„æ”¹å˜
const map2 = map1.set(true, 'yes')

// ğŸ’¡ map2æ˜¯ä¸åŒäºmap0çš„æ–°å¯¹è±¡
// ä½†æ˜¯å®ƒä»¬å†…å®¹ç›¸åŒ
assert.ok(map2 !== map0);
assert.equal(map2.equals(map0), true); // (B)
```

æ³¨æ„ï¼š

- åƒ`.set()`è¿™æ ·çš„â€œç ´åæ€§â€æ“ä½œä¸ä¼šä¿®æ”¹æ¥æ”¶æ–¹ï¼Œè€Œæ˜¯è¿”å›ä¿®æ”¹åçš„å‰¯æœ¬
- ä¸ºäº†æ£€æŸ¥ä¸¤ä¸ªæ•°æ®ç»“æ„æ˜¯å¦å…·æœ‰ç›¸åŒçš„å†…å®¹ï¼Œæˆ‘ä»¬ä½¿ç”¨å†…ç½®çš„`.equals()`æ–¹æ³•(ç¬¬Aè¡Œå’Œç¬¬Bè¡Œ)



<p id="5.2"></p>



### 5.2 Immer

[Immer](https://immerjs.github.io/immer/) ä»“åº“æè¿°å¦‚ä¸‹ï¼š

- é€šè¿‡æ”¹å˜å½“å‰çŠ¶æ€åˆ›å»ºä¸‹ä¸€ä¸ªä¸å¯å˜çŠ¶æ€

Immerå¸®åŠ©éç ´åæ€§åœ°æ›´æ–°(å¯èƒ½åµŒå¥—)æ™®é€šå¯¹è±¡ã€æ•°ç»„ã€Setså’ŒMapsã€‚å³ä¸æ¶‰åŠåˆ°è‡ªå®šä¹‰æ•°æ®ç»“æ„ã€‚

ğŸŒ°ï¼š

```js {7-10}
import { produce } from 'immer/dist/immer.module.js'

const people = [
  {name: 'Jane', work: {employer: 'Acme'}}
]

const modifiedPeople = produce(people, (draft) => {
  draft[0].work.employer = 'Cyberdyne'
  draft.push({name: 'John', work: {employer: 'Spectre'}})
})

assert.deepEqual(modifiedPeople, [
  {name: 'Jane', work: {employer: 'Cyberdyne'}},
  {name: 'John', work: {employer: 'Spectre'}},
])
assert.deepEqual(people, [
  {name: 'Jane', work: {employer: 'Acme'}},
])
```

å­˜å‚¨åœ¨ `people.produce()` ä¸­çš„åŸæ•°æ®ç»™æˆ‘ä»¬æä¾›äº†ä¸€ä¸ªå˜é‡ `draft`ã€‚æˆ‘ä»¬å‡è£…è¿™ä¸ªå˜é‡æ˜¯ `people`ï¼Œç„¶åä½¿ç”¨æ­£å¸¸çš„ç ´åæ€§æ”¹å˜æ“ä½œã€‚**Immerä¼šæ‹¦æˆªè¿™äº›æ“ä½œ**ã€‚å®ƒä¸ä¼šæ”¹å˜ `draft`ï¼Œè€Œæ˜¯å¯¹ `people` è¿›è¡Œéç ´åæ€§çš„æ”¹å˜ã€‚ç»“æœé€šè¿‡ `modifiedPeople` è¿›è¡Œå¼•ç”¨ã€‚é¢å¤–çš„å¥½å¤„æ˜¯ï¼Œå®ƒæ˜¯æ·±åº¦ä¸å¯å˜çš„ğŸš€ã€‚

`assert.deepEqual()` èƒ½æ­£å¸¸è¿ä½œï¼Œæ˜¯å› ä¸ºImmerè¿”å›çš„æ˜¯æ™®é€šå¯¹è±¡å’Œæ•°ç»„ğŸ¤©ã€‚



2022å¹´07æœˆ29æ—¥21:39:12

